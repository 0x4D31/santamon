# Example Santamon macOS Ruleset
# Telemetry: Execution, FileAccess, TCCModification, XProtect, LaunchItem, Disk
#
# Rule Syntax:
#   - All protobuf fields accessed via 'event.' prefix: event.execution.decision
#   - Enum constants used directly (not quoted): DECISION_ALLOW, DECISION_DENY
#   - Check optional fields with has(): has(event.execution.target.code_signature)
#
# Field Extraction (track, group_by, count_distinct, extra_context):
#   - Use 'event.' prefix for consistency: event.execution.target.executable.path
#   - Legacy format without prefix also works: execution.target.executable.path
#
# Optional per-rule context helpers:
#   include_event: true
#   include_process_tree: true
#   extra_context: ["event.execution.args", "event.file_access.instigator.effective_user.name"]

rules:
  - id: SM-001
    title: "Blocked browser cookie access attempt"
    description: "Non-browser process attempted to access Chrome/Comet Cookies DB and was blocked."
    expr: |
      kind == "file_access" &&
      event.file_access.policy_name in ["ChromeCookies","CometCookies"] &&
      event.file_access.policy_decision == POLICY_DECISION_DENIED
    severity: critical
    tags: ["T1539", "credential-access"]
    enabled: true

  - id: SM-002
    title: "SSH private keys read by non-ssh process"
    description: "Any non-ssh process reading ~/.ssh key material."
    expr: |
      kind == "file_access" &&
      event.file_access.policy_name in ["SSHKeys","SSHPrivateKeys"] &&
      !event.file_access.instigator.executable.path.startsWith("/usr/bin/ssh") &&
      !(
        has(event.file_access.instigator.code_signature) &&
        event.file_access.instigator.code_signature.signing_id == "com.apple.ssh"
      )
    severity: critical
    tags: ["T1552.004", "credential-access"]
    enabled: true

  - id: SM-003
    title: "Non-user TCC Full Disk Access grant"
    description: "Full Disk Access (SystemPolicyAllFiles) granted without USER_CONSENT to a non-Apple client."
    expr: |
      kind == "tcc_modification" &&
      event.tcc_modification.service == "kTCCServiceSystemPolicyAllFiles" &&
      event.tcc_modification.authorization_right == AUTHORIZATION_RIGHT_ALLOWED &&
      event.tcc_modification.authorization_reason != AUTHORIZATION_REASON_USER_CONSENT &&
      !event.tcc_modification.identity.startsWith("com.apple.")
    severity: critical
    tags: ["T1548.006", "defense-evasion", "privilege-escalation"]
    enabled: true

  - id: SM-004
    title: "Non-user TCC grant for camera/mic/screen"
    description: "Camera / Microphone / ScreenCapture granted without USER_CONSENT to a non-Apple client."
    expr: |
      kind == "tcc_modification" &&
      event.tcc_modification.service in [
        "kTCCServiceCamera",
        "kTCCServiceMicrophone",
        "kTCCServiceScreenCapture",
        "kTCCServiceListenEvent"
      ] &&
      event.tcc_modification.authorization_right == AUTHORIZATION_RIGHT_ALLOWED &&
      event.tcc_modification.authorization_reason != AUTHORIZATION_REASON_USER_CONSENT &&
      !event.tcc_modification.identity.startsWith("com.apple.")
    severity: high
    tags: ["T1548.006", "collection", "defense-evasion"]
    enabled: true

  - id: SM-005
    title: "XProtect malware detection"
    description: "Any XProtect detection/remediation event from macOS built-in AV."
    expr: kind == "xprotect" && has(event.xprotect.detected)
    severity: critical
    tags: ["T1204.002", "malware"]
    enabled: true

  - id: SM-006
    title: "User LaunchAgent with user-writable binary"
    description: "Legacy LaunchAgent under a user path whose executable also lives in /Users (classic adware/malware persistence)."
    expr: |
      kind == "launch_item" &&
      event.launch_item.action == ACTION_ADD &&
      event.launch_item.item_type == ITEM_TYPE_AGENT &&
      event.launch_item.legacy == true &&
      event.launch_item.item_path.startsWith("/Users/") &&
      has(event.launch_item.executable_path) &&
      event.launch_item.executable_path.startsWith("/Users/")
    severity: high
    tags: ["T1543.001", "persistence"]
    enabled: true

  - id: SM-007
    title: "LaunchDaemon executing from user or volume path"
    description: "Legacy LaunchDaemon whose executable lives under /Users or /Volumes (very abnormal for legit software)."
    expr: |
      kind == "launch_item" &&
      event.launch_item.action == ACTION_ADD &&
      event.launch_item.item_type == ITEM_TYPE_DAEMON &&
      event.launch_item.legacy == true &&
      has(event.launch_item.executable_path) &&
      (
        event.launch_item.executable_path.startsWith("/Users/") ||
        event.launch_item.executable_path.startsWith("/Volumes/")
      )
    severity: high
    tags: ["T1543.004", "persistence"]
    enabled: true

  - id: SM-008
    title: "Unknown-developer binary from user download paths"
    description: "Executable launched from ~/Downloads/Desktop/Documents where the target binary has no TeamID."
    expr: |
      kind == "execution" &&
      event.execution.decision == DECISION_ALLOW &&
      event.execution.target.executable.path.matches("^/Users/.*/(Downloads|Desktop|Documents)/.*") &&
      (
        !has(event.execution.target.code_signature) ||
        !has(event.execution.target.code_signature.team_id) ||
        event.execution.target.code_signature.team_id == ""
      )
    severity: high
    tags: ["T1204.002", "execution"]
    enabled: true

  - id: SM-009
    title: "Chrome spawning a scripting interpreter"
    description: "Chrome/Chromium process launching osascript/shell/interpreters (drive-by or extension abuse)."
    expr: |
      kind == "execution" &&
      event.execution.target.executable.path in [
        "/usr/bin/osascript", "/bin/bash", "/bin/sh",
        "/usr/bin/python3", "/usr/bin/python", "/usr/bin/perl", "/usr/bin/ruby"
      ] &&
      (
        event.execution.instigator.executable.path.contains("Google Chrome") ||
        event.execution.instigator.executable.path.contains("Chromium")
      )
    severity: high
    tags: ["T1059", "T1204", "initial-access"]
    enabled: true

  - id: SM-010
    title: "Third-party process invoking launchctl"
    description: "Non-Apple process invoking launchctl (commonly used to install persistence)."
    expr: |
      kind == "execution" &&
      event.execution.target.executable.path in ["/bin/launchctl","/usr/bin/launchctl"] &&
      !(
        event.execution.instigator.executable.path.startsWith("/System/Library/") ||
        event.execution.instigator.executable.path.startsWith("/usr/libexec/") ||
        event.execution.instigator.executable.path.startsWith("/usr/sbin/")
      ) &&
      !(
        event.execution.instigator.executable.path.contains("/Terminal.app/") ||
        event.execution.instigator.executable.path.contains("/iTerm.app/") ||
        event.execution.instigator.executable.path.contains("/Visual Studio Code.app/") ||
        event.execution.instigator.executable.path.startsWith("/opt/homebrew/")
      )
    severity: high
    tags: ["persistence"]
    enabled: true

  - id: SM-011
    title: "Local password verification via dscl authonly"
    description: "Non-system process invoking dscl with -authonly, often used to validate phished passwords."
    expr: |
      kind == "execution" &&
      event.execution.target.executable.path == "/usr/bin/dscl" &&
      decoded_args.exists(arg, arg == "-authonly") &&
      !event.execution.instigator.executable.path.startsWith("/System/Library/") &&
      !event.execution.instigator.executable.path.startsWith("/usr/sbin/")
    severity: critical
    tags: ["T1056.002", "credential-access"]
    enabled: true

  - id: SM-012
    title: "Suspicious AppleScript password dialog"
    description: "osascript displaying a password prompt with hidden answer, launched by a non-system process."
    expr: |
      kind == "execution" &&
      event.execution.target.executable.path == "/usr/bin/osascript" &&
      decoded_args.exists(arg, arg.contains("display dialog")) &&
      decoded_args.exists(arg, arg.contains("hidden answer")) &&
      !event.execution.instigator.executable.path.startsWith("/System/Library/")
    severity: high
    tags: ["T1056.002", "credential-access", "social-engineering"]
    enabled: true

  - id: SM-013
    title: "Unsigned app executed from mounted volume"
    description: "Unknown-developer binary executed directly from /Volumes (common DMG stealer pattern)."
    expr: |
      kind == "execution" &&
      event.execution.decision == DECISION_ALLOW &&
      event.execution.target.executable.path.startsWith("/Volumes/") &&
      (
        !has(event.execution.target.code_signature) ||
        !has(event.execution.target.code_signature.team_id) ||
        event.execution.target.code_signature.team_id == ""
      )
    severity: high
    tags: ["T1204.002", "initial-access"]
    enabled: true

  # test process tree enrichment
  - id: SM-014
    title: "Non-interactive process invoking curl/wget"
    description: |
      Non-shell, non-terminal, non-package-manager process launching curl or wget.
    expr: |
      kind == "execution" &&
      event.execution.target.executable.path in ["/usr/bin/curl", "/usr/bin/wget"] &&

      // Exclude interactive shells
      !(
        event.execution.instigator.executable.path.startsWith("/bin/bash") ||
        event.execution.instigator.executable.path.startsWith("/bin/zsh") ||
        event.execution.instigator.executable.path.startsWith("/bin/sh")
      ) &&

      // Exclude Homebrew / package-manager helpers that legitimately use curl frequently
      !(
        event.execution.instigator.executable.path.startsWith("/opt/homebrew/") ||
        event.execution.instigator.executable.path.contains("/Homebrew/")
      )
    severity: high
    tags: ["T1105", "command-and-control"]
    extra_context: ["event.execution.args"]
    include_process_tree: true
    enabled: true

# ======================================================
# CORRELATION RULES
# ======================================================

correlations:
  - id: SM-COR-001
    title: "Process touching multiple credential stores"
    description: "Single process accessing 3+ credential stores (cookies, SSH, keychain, passwords) within 5 minutes."
    expr: |
      kind == "file_access" &&
      event.file_access.policy_name in [
        "ChromeCookies",
        "CometCookies",
        "SSHPrivateKeys",
        "BrowserPasswords",
        "KeychainDB"
      ]
    window: "5m"
    group_by:
      - "event.file_access.instigator.executable.path"
    count_distinct: "event.file_access.policy_name"
    threshold: 3
    severity: critical
    tags: ["T1539", "T1552", "credential-access", "collection"]
    enabled: true

  # TODO: Add sequential multi-stage correlation (A THEN B in window) when engine supports it.

# ======================================================
# BASELINE RULES (FIRST-SEEN ONLY)
# ======================================================

baselines:
  - id: SM-BASE-001
    title: "First-time unsigned binary executed from user paths"
    description: "First time an unsigned binary executes from /Users paths during the learning window."
    expr: |
      kind == "execution" &&
      event.execution.decision == DECISION_ALLOW &&
      event.execution.target.executable.path.startsWith("/Users/") &&
      (
        !has(event.execution.target.code_signature) ||
        !has(event.execution.target.code_signature.team_id) ||
        event.execution.target.code_signature.team_id == ""
      )
    track:
      - "event.execution.target.executable.cdhash"
    learning_period: "720h"
    severity: high
    tags: ["T1204.002", "initial-access", "execution"]
    enabled: true

  - id: SM-BASE-002
    title: "Binary hash change for executable path"
    description: "Detects when the code signature hash for a given executable path changes (possible binary replacement)."
    expr: |
      kind == "execution" &&
      event.execution.target.executable.path != "" &&
      event.execution.target.executable.hash.hash != ""
    track:
      - "event.execution.target.executable.path"
      - "event.execution.target.executable.hash.hash"
    learning_period: "168h"    # Suppress alerts for 7 days
    severity: high
    tags: ["T1036", "defense-evasion", "baseline"]
    enabled: false
